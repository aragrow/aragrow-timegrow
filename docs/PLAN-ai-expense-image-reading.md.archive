# AI-Powered Expense Image Reading - Full Implementation Plan

## Context

The TimeGrow WordPress plugin **already has AI-powered receipt analysis infrastructure** built with Google Gemini Vision API. However, there are critical bugs preventing it from working as expected, plus missing features for a complete user experience.

### Current State
- âœ… Complete database schema with receipt storage and AI analysis tracking
- âœ… Google Gemini Vision API integration with base64 image encoding
- âœ… Confidence scoring and threshold filtering
- âœ… Client/Project pattern matching from receipt text
- âœ… Multi-provider settings infrastructure (Google, OpenAI, Anthropic)
- âœ… Encrypted API key storage via VoiceAI Security class
- âœ… File upload with drag-drop UI (JPEG, PNG, PDF accepted)

### Critical Issues Discovered
1. **Line 101 bug in TimeGrowExpenseController.php**: AI analysis only runs when `$id != 0` (editing expenses), NOT when `$id == 0` (creating new expenses) - this is backwards!
2. **Limited category mapping**: Gemini prompt only asks for basic categories (office_supplies, travel, meals) but the system has 33 IRS Schedule C categories
3. **No OpenAI/Anthropic implementation**: Settings exist but only Gemini analyzer is coded
4. **No PDF support**: Upload accepts PDFs but analyzer only handles JPEG/PNG
5. **No visual feedback**: Users don't see loading states during AI analysis
6. **No batch upload**: Only single file upload supported

### User Requirements
- **Priority**: Full-featured upgrade with all enhancements
- **Analysis Mode**: User-Approved (AI analyzes only after user checks approval box)
- **Smart Population**: AI populates only empty fields, warns about mismatches
- **Graceful Degradation**: System works even if AI not configured

---

## Implementation Plan

### Phase 1: Fix Critical Bugs (Immediate Value)

#### 1.1 Fix the `$id != 0` Bug
**File**: `/modules/core/includes/controllers/TimeGrowExpenseController.php`

**Change at line 101**:
```php
// BEFORE:
if ($enable_analysis && $id != 0) {

// AFTER:
if ($enable_analysis && $id == 0) {
```

**Rationale**: Users want AI to analyze receipts when *creating* new expenses, not when editing existing ones. The current logic is inverted.

#### 1.2 Update Gemini Prompt with All IRS Categories
**File**: `/modules/core/includes/helpers/TimeGrowGeminiReceiptAnalyzer.php`

**Update `get_extraction_prompt()` method (lines 198-222)** to include all 33 IRS Schedule C category slugs from the database instead of generic categories.

**Categories to include**:
- Part II: advertising, car_truck_expenses, commissions_fees, contract_labor, depletion, depreciation, employee_benefits, insurance_other, interest_mortgage, interest_other, legal_professional, office_expense, pension_profit_sharing, rent_lease_vehicles, rent_lease_property, repairs_maintenance, supplies, taxes_licenses, travel, meals_50_deductible, utilities, wages
- Part V: online_fees, telephone, education_training, membership_dues, books_publications, photography_stock, marketing_materials, shipping_postage, bank_fees, credit_card_fees, other_expenses

**Enhancement**: Add AI instruction to map common receipt vendors to specific categories (e.g., "Staples" â†’ "office_expense", "Shell Gas" â†’ "car_truck_expenses")

---

### Phase 2: Multi-Provider AI Support

#### 2.1 Create Base Analyzer Interface
**New file**: `/modules/core/includes/helpers/TimeGrowReceiptAnalyzerInterface.php`

Define interface with:
```php
interface TimeGrowReceiptAnalyzerInterface {
    public function analyze_receipt($image_url, $options = []);
    public function supports_pdf();
}
```

#### 2.2 Refactor Gemini Analyzer
**File**: `/modules/core/includes/helpers/TimeGrowGeminiReceiptAnalyzer.php`

- Implement `TimeGrowReceiptAnalyzerInterface`
- Keep all existing functionality
- Add `supports_pdf()` method returning `false` for now

#### 2.3 Create OpenAI Analyzer
**New file**: `/modules/core/includes/helpers/TimeGrowOpenAIReceiptAnalyzer.php`

**Implementation details**:
- Use GPT-4o or GPT-4o-mini models
- API endpoint: `https://api.openai.com/v1/chat/completions`
- Image handling: Base64 encoding in `image_url` format
- Request format:
  ```json
  {
    "model": "gpt-4o",
    "messages": [
      {
        "role": "user",
        "content": [
          {"type": "text", "text": "[extraction prompt]"},
          {"type": "image_url", "image_url": {"url": "data:image/jpeg;base64,..."}}
        ]
      }
    ],
    "max_tokens": 1000
  }
  ```
- Parse JSON response from `choices[0].message.content`
- Add same category mapping and client/project pattern matching

#### 2.4 Create Anthropic Claude Analyzer
**New file**: `/modules/core/includes/helpers/TimeGrowClaudeReceiptAnalyzer.php`

**Implementation details**:
- Use Claude 3.5 Sonnet or Claude 3 Opus models
- API endpoint: `https://api.anthropic.com/v1/messages`
- Headers: `x-api-key`, `anthropic-version: 2023-06-01`
- Image handling: Base64 with `image/jpeg` or `image/png` media type
- Request format:
  ```json
  {
    "model": "claude-3-5-sonnet-20241022",
    "max_tokens": 1024,
    "messages": [
      {
        "role": "user",
        "content": [
          {"type": "image", "source": {"type": "base64", "media_type": "image/jpeg", "data": "..."}},
          {"type": "text", "text": "[extraction prompt]"}
        ]
      }
    ]
  }
  ```
- Parse JSON response from `content[0].text`
- Add same category mapping and client/project pattern matching

#### 2.5 Create Analyzer Factory
**New file**: `/modules/core/includes/helpers/TimeGrowReceiptAnalyzerFactory.php`

Factory class to instantiate correct analyzer based on settings:
```php
class TimeGrowReceiptAnalyzerFactory {
    public static function create() {
        $settings = get_option('aragrow_timegrow_ai_settings', []);
        $provider = $settings['ai_provider'] ?? 'google_gemini';

        switch ($provider) {
            case 'openai':
                return new TimeGrowOpenAIReceiptAnalyzer();
            case 'anthropic':
                return new TimeGrowClaudeReceiptAnalyzer();
            case 'google_gemini':
            default:
                return new TimeGrowGeminiReceiptAnalyzer();
        }
    }
}
```

#### 2.6 Update Controller to Use Factory
**File**: `/modules/core/includes/controllers/TimeGrowExpenseController.php`

**Change at line 103**:
```php
// BEFORE:
$analyzer = new TimeGrowGeminiReceiptAnalyzer();

// AFTER:
$analyzer = TimeGrowReceiptAnalyzerFactory::create();
```

---

### Phase 3: Enhanced User Experience

#### 3.1 Add Visual Loading State
**File**: `/modules/core/assets/js/expense.js`

Add after file upload event handlers (around line 50):
```javascript
// Show AI analysis loading indicator
function showAIAnalysisLoading() {
    const loadingHtml = `
        <div id="ai-analysis-loading" class="notice notice-info">
            <p>
                <span class="spinner is-active" style="float:left; margin: 0 10px 0 0;"></span>
                Analyzing receipt with AI... This may take a few seconds.
            </p>
        </div>
    `;
    $('.wrap h1').after(loadingHtml);
}

// Update file upload handler to show loading on form submit
$('form[name="expense_form"]').on('submit', function() {
    if (fileInput[0].files.length > 0) {
        showAIAnalysisLoading();
    }
});
```

**File**: `/modules/core/includes/views/TimeGrowExpenseView.php`

Add hidden flag to form to trigger JS loading state (in both add and edit forms).

#### 3.2 Display Confidence Scores in Receipt List
**File**: `/modules/core/includes/views/TimeGrowExpenseView.php`

In `edit_expense()` method where receipts are displayed (around lines 370-400), enhance receipt display:

```php
// Show confidence badge if available
if (!empty($receipt->gemini_confidence)) {
    $confidence_pct = round($receipt->gemini_confidence * 100);
    $badge_class = $confidence_pct >= 80 ? 'success' : ($confidence_pct >= 60 ? 'warning' : 'error');
    echo "<span class='confidence-badge badge-{$badge_class}'>";
    echo "AI Confidence: {$confidence_pct}%";
    echo "</span>";
}
```

Add corresponding CSS in `/modules/core/assets/css/expense.css`.

#### 3.3 Add "Re-Analyze Receipt" Button
**File**: `/modules/core/includes/views/TimeGrowExpenseView.php`

In `edit_expense()` view, add button next to each receipt:
```php
<button type="button" class="button reanalyze-receipt" data-receipt-id="<?php echo $receipt->ID; ?>">
    Re-Analyze with AI
</button>
```

**File**: `/modules/core/assets/js/expense.js`

Add AJAX handler:
```javascript
$('.reanalyze-receipt').on('click', function() {
    const receiptId = $(this).data('receipt-id');
    const button = $(this);

    button.prop('disabled', true).text('Analyzing...');

    $.ajax({
        url: ajaxurl,
        method: 'POST',
        data: {
            action: 'timegrow_reanalyze_receipt',
            receipt_id: receiptId,
            nonce: timegrow_ajax_nonce
        },
        success: function(response) {
            if (response.success) {
                location.reload(); // Refresh to show updated data
            } else {
                alert('Analysis failed: ' + response.data.message);
                button.prop('disabled', false).text('Re-Analyze with AI');
            }
        },
        error: function() {
            alert('Network error. Please try again.');
            button.prop('disabled', false).text('Re-Analyze with AI');
        }
    });
});
```

**File**: `/modules/core/includes/controllers/TimeGrowExpenseController.php`

Add new AJAX handler method:
```php
public function ajax_reanalyze_receipt() {
    check_ajax_referer('timegrow_ajax_nonce', 'nonce');

    $receipt_id = intval($_POST['receipt_id']);
    $receipt = $this->receipt_model->select($receipt_id);

    if (!$receipt) {
        wp_send_json_error(['message' => 'Receipt not found']);
    }

    $analyzer = TimeGrowReceiptAnalyzerFactory::create();
    $analysis = $analyzer->analyze_receipt($receipt->file_url);

    if (is_wp_error($analysis)) {
        wp_send_json_error(['message' => $analysis->get_error_message()]);
    }

    // Update expense with new analysis
    // [logic similar to handle_form_submission lines 107-157]

    wp_send_json_success(['message' => 'Receipt re-analyzed successfully']);
}
```

Register AJAX actions in main plugin file or controller constructor.

---

### Phase 3.4: Smart Field Population Logic âœ… COMPLETED
**Files Modified:**
- `modules/core/includes/controllers/TimeGrowExpenseController.php` - Lines 107-180

**Implementation:**
- âœ… Only populates empty fields (never overwrites user data)
- âœ… Mismatch detection for Amount, Date, Vendor, Category
- âœ… Warnings display when user data differs from receipt
- âœ… Success messages show which fields were populated
- âœ… Confidence percentage displayed to user

**Example Logic:**
```php
// Amount field
if (!empty($analysis['amount'])) {
    $ai_amount = floatval($analysis['amount']);
    $user_amount = floatval($data['amount'] ?? 0);

    if ($user_amount == 0 || empty($data['amount'])) {
        // User field is empty â†’ populate
        $updated_data['amount'] = $ai_amount;
        $populated_fields[] = 'Amount ($' . number_format($ai_amount, 2) . ')';
    } elseif (abs($user_amount - $ai_amount) > 0.01) {
        // User entered different value â†’ warn
        $warnings[] = 'Amount mismatch: You entered $' . number_format($user_amount, 2) .
                      ', but receipt shows $' . number_format($ai_amount, 2);
    }
}
```

**Documentation:** See `docs/AI-SMART-POPULATION.md`

---

### Phase 3.5: User Approval System âœ… COMPLETED
**Files Modified:**
- `modules/core/includes/views/TimeGrowExpenseView.php` - Lines 150-165 (approval checkbox UI)
- `modules/core/assets/js/expense.js` - Lines 48-64 (show/hide logic)
- `modules/core/includes/controllers/TimeGrowExpenseController.php` - Lines 93-105 (approval check)

**Implementation:**
- âœ… Checkbox appears automatically when file uploaded (slideDown animation)
- âœ… Shows provider name: "Analyze this receipt with AI (Google Gemini)..."
- âœ… Auto-checked by default for user convenience
- âœ… User can uncheck if they don't want AI for that receipt
- âœ… AI only runs if checkbox is checked

**User Experience Flow:**
```
1. User uploads receipt
   â†“
2. Checkbox appears with smooth animation
   â†“
3. Checkbox auto-checked (user can uncheck)
   â†“
4. User submits form
   â†“
5. AI runs ONLY if checked
```

---

### Phase 3.6: Configuration Validation & Graceful Degradation âœ… COMPLETED
**Files Modified:**
- `modules/core/includes/controllers/TimeGrowExpenseController.php` - Lines 95-110

**Implementation:**
- âœ… Validates AI configuration before attempting analysis
- âœ… Checks: API key exists AND provider selected
- âœ… Warning message if not configured: "âš  AI Analysis Skipped: AI is not properly configured..."
- âœ… Expense saves successfully regardless of AI status
- âœ… No blocking errors - graceful degradation

**Validation Logic:**
```php
$settings = get_option('aragrow_timegrow_ai_settings', []);
$ai_configured = !empty($settings['ai_api_key']) && !empty($settings['ai_provider']);
$user_approved = isset($_POST['approve_ai_analysis']) && $_POST['approve_ai_analysis'] == '1';

if (!$ai_configured) {
    echo '<div class="notice notice-warning">AI not configured. Please add API key in Settings.</div>';
    // Continue saving expense without AI
} elseif (!$user_approved) {
    // User chose not to use AI - skip analysis
    // Continue saving expense without AI
} else {
    // Run AI analysis
    $analyzer = TimeGrowReceiptAnalyzerFactory::create();
    // ...
}
```

---

### Phase 4: PDF Support

#### 4.1 Add PDF Text Extraction Library
**File**: `/modules/core/includes/helpers/TimeGrowPDFExtractor.php`

Use one of these approaches:
- **Option A**: Use `pdftotext` command-line tool via `shell_exec()` if available
- **Option B**: Use PHP library like `smalot/pdfparser` (requires composer)
- **Option C**: Convert PDF to images using Imagick and analyze images

**Recommended**: Option C with fallback to error message if Imagick not available.

```php
class TimeGrowPDFExtractor {
    public static function pdf_to_images($pdf_path) {
        if (!extension_loaded('imagick')) {
            return new WP_Error('no_imagick', 'PDF processing requires Imagick extension');
        }

        $imagick = new Imagick();
        $imagick->setResolution(300, 300);
        $imagick->readImage($pdf_path);
        $imagick->setImageFormat('jpeg');

        // Return first page as JPEG for analysis
        $blob = $imagick->getImageBlob();
        return $blob;
    }
}
```

#### 4.2 Update Gemini Analyzer to Handle PDFs
**File**: `/modules/core/includes/helpers/TimeGrowGeminiReceiptAnalyzer.php`

Update `prepare_image_for_api()` method:
```php
// If PDF, convert to image first
if ($mime_type === 'application/pdf') {
    $pdf_blob = TimeGrowPDFExtractor::pdf_to_images($image_path);
    if (is_wp_error($pdf_blob)) {
        return $pdf_blob;
    }
    $image_content = $pdf_blob;
    $mime_type = 'image/jpeg';
}
```

Update `supports_pdf()` to return `true` if Imagick available.

#### 4.3 Apply Same PDF Support to OpenAI and Claude Analyzers
Replicate PDF handling in both new analyzer classes.

---

### Phase 5: Bulk Upload Support

#### 5.1 Update Form to Accept Multiple Files
**File**: `/modules/core/includes/views/TimeGrowExpenseView.php`

In `add_expense()` method, modify file input:
```php
<input type="file" id="file_upload" name="file_upload[]" accept=".jpg,.jpeg,.png,.pdf,.doc,.docx" style="display:none;" multiple>
```

Update dropzone messaging:
```php
<p>Drag & drop receipt images here, or click to select files</p>
<p class="description">Upload multiple receipts at once (JPEG, PNG, or PDF, max 512KB each)</p>
```

#### 5.2 Update JavaScript for Multiple Files
**File**: `/modules/core/assets/js/expense.js`

Update file status display:
```javascript
fileInput.on('change', function() {
    if (this.files.length > 0) {
        const fileNames = Array.from(this.files).map(f => f.name).join(', ');
        status.text(`${this.files.length} file(s) selected: ${fileNames}`);
    }
});
```

#### 5.3 Update Controller to Process Multiple Files
**File**: `/modules/core/includes/controllers/TimeGrowExpenseController.php`

Replace single file handling (lines 87-177) with loop:
```php
if (!empty($_FILES['file_upload']['name'][0])) {
    $uploaded_files = $_FILES['file_upload'];
    $file_count = count($uploaded_files['name']);

    for ($i = 0; $i < $file_count; $i++) {
        $file = [
            'name' => $uploaded_files['name'][$i],
            'type' => $uploaded_files['type'][$i],
            'tmp_name' => $uploaded_files['tmp_name'][$i],
            'error' => $uploaded_files['error'][$i],
            'size' => $uploaded_files['size'][$i],
        ];

        // Process each file individually
        // [existing upload and analysis logic]
    }

    echo "<div class='notice notice-success'><p>{$file_count} receipt(s) processed successfully!</p></div>";
}
```

**Important**: For bulk upload, consider:
- Analyzing only the first receipt automatically to populate expense fields
- Storing all other receipts as additional attachments
- Adding a UI to select which receipt to use as primary for analysis

---

### Phase 6: Improved Accuracy & Error Handling

#### 6.1 Enhanced Category Mapping
**File**: `/modules/core/includes/helpers/TimeGrowGeminiReceiptAnalyzer.php` (and other analyzers)

Add vendor-to-category mapping:
```php
private function get_vendor_category_hints() {
    return [
        'staples' => 'office_expense',
        'office depot' => 'office_expense',
        'shell' => 'car_truck_expenses',
        'chevron' => 'car_truck_expenses',
        'restaurant' => 'meals_50_deductible',
        'uber' => 'travel',
        'fedex' => 'shipping_postage',
        // ... add more mappings
    ];
}
```

Update prompt to include vendor hints.

#### 6.2 Better Error Messages
**File**: `/modules/core/includes/controllers/TimeGrowExpenseController.php`

Enhance error handling (lines 161-169):
```php
elseif (is_wp_error($analysis)) {
    $error_code = $analysis->get_error_code();
    $user_friendly_messages = [
        'no_api_key' => 'AI analysis is not configured. Please add your API key in Settings.',
        'rate_limit' => 'Too many requests. Please wait a moment and try again.',
        'invalid_mime_type' => 'This file type is not supported for AI analysis.',
    ];

    $message = $user_friendly_messages[$error_code] ?? $analysis->get_error_message();
    echo '<div class="notice notice-warning"><p>' . esc_html($message) . '</p></div>';
}
```

#### 6.3 Add Confidence Threshold Setting UI Enhancement
**File**: `/modules/core/includes/TimeGrowSettings.php`

Add slider with visual feedback for confidence threshold setting:
```php
<input type="range" min="0" max="100" step="5" value="<?php echo $confidence * 100; ?>"
       id="confidence_slider" oninput="updateConfidenceLabel(this.value)">
<span id="confidence_label"><?php echo $confidence * 100; ?>%</span>
<p class="description">AI must be at least this confident before auto-filling expense data</p>
```

---

## Critical Files to Modify

### Core Files (Must Edit)
1. `/modules/core/includes/controllers/TimeGrowExpenseController.php` - Fix bug, add multi-file handling, AJAX handler
2. `/modules/core/includes/helpers/TimeGrowGeminiReceiptAnalyzer.php` - Update prompt, add PDF support, implement interface
3. `/modules/core/includes/views/TimeGrowExpenseView.php` - Add confidence display, re-analyze button, multi-file UI
4. `/modules/core/assets/js/expense.js` - Loading states, AJAX handlers, multi-file support
5. `/modules/core/includes/TimeGrowSettings.php` - Enhanced UI for confidence threshold

### New Files (Must Create)
1. `/modules/core/includes/helpers/TimeGrowReceiptAnalyzerInterface.php` - Interface definition
2. `/modules/core/includes/helpers/TimeGrowOpenAIReceiptAnalyzer.php` - OpenAI implementation
3. `/modules/core/includes/helpers/TimeGrowClaudeReceiptAnalyzer.php` - Anthropic implementation
4. `/modules/core/includes/helpers/TimeGrowReceiptAnalyzerFactory.php` - Factory pattern
5. `/modules/core/includes/helpers/TimeGrowPDFExtractor.php` - PDF processing
6. `/modules/core/assets/css/expense-ai.css` - AI-specific styling (confidence badges, loading states)

### Supporting Files (Minor Updates)
1. `/modules/core/aragrow-timegrow-core.php` - Register new AJAX actions
2. `/modules/core/includes/models/TimeGrowExpenseReceiptModel.php` - May need method to fetch receipt by ID for re-analysis

---

## Testing & Verification Plan

### Unit Testing
1. **Test analyzer factory** - Verify correct analyzer instantiated for each provider setting
2. **Test PDF extraction** - Upload PDF receipts, verify conversion to images
3. **Test category mapping** - Send various vendor names, verify correct IRS categories returned
4. **Test multi-file upload** - Upload 5 receipts, verify all saved to database

### Integration Testing
1. **Test end-to-end new expense creation**:
   - Upload receipt image â†’ AI analyzes â†’ Form pre-fills â†’ Save â†’ Verify database
   - Test with Google Gemini, OpenAI, and Anthropic
2. **Test confidence thresholds**:
   - Set threshold to 90% â†’ Upload low-quality receipt â†’ Verify no auto-fill
   - Set threshold to 50% â†’ Upload same receipt â†’ Verify auto-fill occurs
3. **Test re-analysis**:
   - Edit existing expense â†’ Click "Re-Analyze" â†’ Verify fields update
4. **Test error scenarios**:
   - Invalid API key â†’ Verify friendly error message
   - Network timeout â†’ Verify graceful degradation
   - Unsupported file type â†’ Verify clear error message

### User Acceptance Testing
1. **Real receipt uploads** - Test with 10+ real receipts from various vendors
2. **Category accuracy** - Verify AI selects correct IRS Schedule C categories
3. **Client/Project matching** - Add "CLIENT: ABC Corp" to receipt, verify auto-assignment
4. **Bulk workflow** - Upload 5 receipts for a business trip, verify smooth experience
5. **Mobile testing** - Test file upload from mobile devices

### Performance Testing
1. **API response times** - Measure analysis time for each provider (should be < 10 seconds)
2. **Bulk upload** - Upload 10 receipts simultaneously, monitor server load
3. **Database queries** - Verify no N+1 queries when displaying receipts with confidence scores

---

## Implementation Order

1. **Quick Win** - Fix line 101 bug and update Gemini prompt (30 min)
2. **Multi-Provider** - Create interface, OpenAI/Claude analyzers, factory (4 hours)
3. **UX Enhancements** - Loading states, confidence display, re-analyze button (3 hours)
4. **PDF Support** - Add PDF extraction and handling (2 hours)
5. **Bulk Upload** - Multi-file form and processing (3 hours)
6. **Polish** - Error handling, category mapping, testing (2 hours)

**Total Estimated Effort**: 14-16 hours

---

## Success Metrics

### âœ… Completed (Core Features)
- âœ… AI analysis runs only with user approval (checkbox required)
- âœ… Smart field population - only fills empty fields, never overwrites user data
- âœ… Mismatch detection warns about potential data entry errors
- âœ… All 33 IRS Schedule C categories properly mapped
- âœ… Users can choose between Google Gemini, OpenAI, or Anthropic
- âœ… Visual loading indicators keep users informed
- âœ… Configuration validation with graceful degradation
- âœ… Multi-provider architecture with factory pattern
- âœ… Modern settings page with card-based UI
- âœ… Security: encrypted API keys, rate limiting, input sanitization

### ðŸ”® Optional Future Enhancements
- ðŸ”® PDF receipts processing with Imagick conversion
- ðŸ”® Bulk upload accepts and analyzes 5+ receipts in one action
- ðŸ”® Confidence scores displayed in receipt list
- ðŸ”® Re-analysis feature works on existing receipts
